<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>My Calendar</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#9ca3af; --line:#223049; --text:#e5e7eb;
    --brand:#3b82f6; --brand-weak:#dbeafe; --danger:#ef4444;
    --scale: 0.92;            /* global scale <— smaller calendar */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; font-size:14px; transform-origin: top left; }
  .wrap{max-width:980px;margin:0 auto;padding:14px; transform: scale(var(--scale));}
  header{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px}
  header h1{margin:0;font-size:18px}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{border:none;border-radius:9px;padding:8px 10px;font-weight:700;color:#fff;cursor:pointer; font-size:13px}
  .btn-brand{background:var(--brand)} .btn-dark{background:#374151} .btn-danger{background:var(--danger)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .chip{background:#1f2937;color:var(--muted);border:1px solid #2b3b52;border-radius:999px;padding:5px 9px;font-size:12px}

  .bar{display:flex;gap:8px;align-items:center;margin:8px 0 12px}
  .cal-select{display:flex;gap:6px;flex-wrap:wrap}

  .grid{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .dow{display:grid;grid-template-columns:repeat(7,1fr);background:#0b1324;border-bottom:1px solid var(--line)}
  .dow div{padding:8px 6px;text-align:center;color:var(--muted);font-weight:600;font-size:11px;letter-spacing:.2px}
  .cells{display:grid;grid-template-columns:repeat(7,1fr)}
  .day{border-right:1px solid var(--line);border-bottom:1px solid var(--line);min-height:84px;cursor:pointer;position:relative}
  .day:nth-child(7n){border-right:none}
  .day .num{position:absolute;top:6px;right:6px;font-weight:700;font-size:11px;color:var(--muted)}
  .day.today{background:rgba(59,130,246,.10);outline:2px solid var(--brand)}
  .day.other{opacity:.45}
  .events{margin-top:24px;padding:5px;display:flex;flex-direction:column;gap:4px}
  .pill{font-size:11px;border-radius:7px;padding:3px 5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .legend{display:flex;gap:8px;flex-wrap:wrap}
  .legend .sw{width:10px;height:10px;border-radius:3px;display:inline-block;margin-right:6px;vertical-align:-1px}

  .muted{color:var(--muted)}
  .monthnav{display:flex;gap:6px;align-items:center}
  .monthname{font-weight:700}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:12px;z-index:40}
  .modal.open{display:flex}
  .card{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:14px;max-width:420px;width:100%}
  .card h3{margin:0 0 8px; font-size:16px}
  .field{margin-bottom:8px}
  label{display:block;font-weight:600;margin-bottom:4px;color:#cbd5e1;font-size:12px}
  input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #2a3954;background:#0a1220;color:var(--text); font-size:13px}
  .row{display:flex;gap:8px}
  .right{display:flex;gap:8px;justify-content:flex-end;margin-top:6px}
  #status{color:#8ab4f8; font-size:12px; margin-left:8px}
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div style="display:flex;align-items:center;gap:8px">
      <h1>My Calendar</h1><span id="status"></span>
    </div>
    <div class="controls">
      <button id="btnSignIn" class="btn btn-brand" disabled>Sign in with Google</button>
      <button id="btnSignOut" class="btn btn-danger" style="display:none">Sign out</button>
      <span id="userChip" class="chip" style="display:none"></span>
    </div>
  </header>

  <div class="bar">
    <div class="monthnav">
      <button id="prev" class="btn btn-dark" title="Previous month">‹</button>
      <div id="monthLabel" class="monthname"></div>
      <button id="next" class="btn btn-dark" title="Next month">›</button>
      <button id="today" class="btn btn-brand" title="Jump to today">Today</button>
    </div>
  </div>

  <div class="bar" style="justify-content:space-between;align-items:flex-start;flex-wrap:wrap">
    <div>
      <div class="muted" style="margin-bottom:4px">Calendars (toggle):</div>
      <div id="calendarList" class="cal-select"></div>
    </div>
    <div>
      <div class="muted" style="margin-bottom:4px">Legend:</div>
      <div id="legend" class="legend"></div>
    </div>
  </div>

  <div class="grid">
    <div class="dow">
      <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
    </div>
    <div id="cells" class="cells"></div>
  </div>
</div>

<!-- Create Event Modal -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="card">
    <h3 id="modalTitle">Create event</h3>
    <div class="field">
      <label for="evtCal">Calendar</label>
      <select id="evtCal"></select>
    </div>
    <div class="field">
      <label for="evtSummary">Title</label>
      <input id="evtSummary" type="text" placeholder="Event title" />
    </div>
    <div class="field">
      <label><input id="evtAllDay" type="checkbox" /> All-day</label>
    </div>
    <div id="timeRow" class="row">
      <div class="field" style="flex:1">
        <label for="evtStart">Start</label>
        <input id="evtStart" type="time" value="09:00" />
      </div>
      <div class="field" style="flex:1">
        <label for="evtEnd">End</label>
        <input id="evtEnd" type="time" value="10:00" />
      </div>
    </div>
    <div class="right">
      <button class="btn btn-dark" id="btnCancel">Cancel</button>
      <button class="btn btn-brand" id="btnSave">Save</button>
    </div>
    <div id="modalMsg" class="muted" style="margin-top:6px"></div>
  </div>
</div>

<!-- Google APIs -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<script>
/* ======  CONFIG (put your keys)  ====== */
const GOOGLE_API_KEY   = "AIzaSyB9duUEU_E_IJmN8-5YcwIk4DcFDMbEzMo";
const GOOGLE_CLIENT_ID = "66134325502-f5d827mojq33api81t33l4uoqur51ssq.apps.googleusercontent.com";

/* ======  Google API setup  ====== */
const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
const SCOPES = "https://www.googleapis.com/auth/calendar";

const TZ = Intl.DateTimeFormat().resolvedOptions().timeZone;

/* ======  DOM refs & state  ====== */
const cellsEl = document.getElementById("cells");
const monthLabel = document.getElementById("monthLabel");
const calListEl = document.getElementById("calendarList");
const legendEl = document.getElementById("legend");
const modalEl = document.getElementById("modal");
const evtCalSel = document.getElementById("evtCal");
const evtSummary = document.getElementById("evtSummary");
const evtAllDay = document.getElementById("evtAllDay");
const timeRow = document.getElementById("timeRow");
const evtStart = document.getElementById("evtStart");
const evtEnd = document.getElementById("evtEnd");
const modalMsg = document.getElementById("modalMsg");
const btnSignIn = document.getElementById("btnSignIn");
const btnSignOut = document.getElementById("btnSignOut");
const userChip = document.getElementById("userChip");
const statusEl = document.getElementById("status");

let current = new Date();
let calendars = [];
let activeCalIds = new Set();
let eventsByDay = {};
let tokenClient, accessToken;
let gapiInited = false, gisInited = false;

/* ======  Helpers ====== */
const sameDate = (a,b)=> a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
const isoDate = d => d.toISOString().slice(0,10);
const hexA = (hex,a)=>{ const c=hex.replace("#",""); const r=parseInt(c.substr(0,2),16),g=parseInt(c.substr(2,2),16),b=parseInt(c.substr(4,2),16); return `rgba(${r},${g},${b},${a})`; };

function setStatus(msg){ statusEl.textContent = msg || ""; }

/* ======  Load + Init  ====== */
function gapiLoaded() {
  gapi.load('client', async () => {
    await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: DISCOVERY_DOCS });
    gapiInited = true;
    maybeStart();
  });
}
function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: SCOPES,
    callback: (resp) => {
      if (resp.error) { console.error(resp); setStatus("Auth error"); return; }
      accessToken = resp.access_token;
      afterSignIn();
    }
  });
  gisInited = true;
  maybeStart();
}
window.gapiLoaded = gapiLoaded;
window.gisLoaded  = gisLoaded;

function maybeStart(){
  if (!(gapiInited && gisInited)) return;
  btnSignIn.disabled = false;

  // Try silent token on load
  setStatus("Connecting…");
  tokenClient.requestAccessToken({ prompt: '' });   // ← silent attempt
}

async function afterSignIn(){
  btnSignIn.style.display = "none";
  btnSignOut.style.display = "";
  setStatus("Signed in");

  // user chip
  try{
    const res = await gapi.client.request({ path: "https://www.googleapis.com/oauth2/v1/userinfo?alt=json",
      headers: { Authorization: "Bearer " + accessToken }});
    const u = res.result;
    userChip.textContent = u.email || u.name || "Signed in";
    userChip.style.display = "";
  }catch{}

  await loadCalendars();
  renderMonth();
  await refreshEvents();
}

function needExplicitSignIn(){
  // Show button if silent failed
  btnSignIn.style.display = "";
  btnSignOut.style.display = "none";
  userChip.style.display = "none";
  setStatus("Sign in required");
}

/* ======  Wire UI ====== */
window.onload = () => {
  renderMonth();
  document.getElementById("prev").onclick = () => { current.setMonth(current.getMonth()-1); renderMonth(); refreshEvents(); };
  document.getElementById("next").onclick = () => { current.setMonth(current.getMonth()+1); renderMonth(); refreshEvents(); };
  document.getElementById("today").onclick = () => { current = new Date(); renderMonth(); refreshEvents(); };

  btnSignIn.onclick = () => tokenClient.requestAccessToken({ prompt: 'consent' });
  btnSignOut.onclick = signOut;
  document.getElementById("btnCancel").onclick = closeModal;
  document.getElementById("btnSave").onclick = saveEvent;
  evtAllDay.onchange = () => timeRow.style.display = evtAllDay.checked ? "none" : "flex";

  // If silent fails (no Google session), show sign-in
  setTimeout(() => { if (!accessToken) needExplicitSignIn(); }, 2000);
};

/* ======  Calendar list & toggles ====== */
async function loadCalendars(){
  const resp = await gapi.client.calendar.calendarList.list({ minAccessRole:"reader", showHidden:false });
  calendars = resp.result.items || [];
  // restore selection
  const saved = JSON.parse(localStorage.getItem("activeCalIds") || "null");
  activeCalIds = new Set(Array.isArray(saved) ? saved : []);
  if (activeCalIds.size===0){
    const primary = calendars.find(c=>c.primary) || calendars[0];
    if (primary) activeCalIds.add(primary.id);
  }
  renderCalendarToggles();
}
function renderCalendarToggles(){
  calListEl.innerHTML=""; legendEl.innerHTML="";
  calendars.forEach(cal=>{
    const id = cal.id, color = cal.backgroundColor || "#2563eb";
    const wrap = document.createElement("label");
    wrap.style.cssText = "display:flex;align-items:center;gap:6px;border:1px solid #2b3b52;padding:5px 9px;border-radius:999px;cursor:pointer;user-select:none;font-size:12px";
    const cb = document.createElement("input");
    cb.type="checkbox"; cb.checked = activeCalIds.has(id);
    cb.onchange = () => {
      cb.checked ? activeCalIds.add(id) : activeCalIds.delete(id);
      localStorage.setItem("activeCalIds", JSON.stringify([...activeCalIds]));
      refreshEvents();
    };
    const sw = document.createElement("span"); sw.className="sw"; sw.style="width:10px;height:10px;border-radius:3px;display:inline-block;background:"+color;
    const name = document.createElement("span"); name.textContent = cal.summary;
    wrap.appendChild(cb); wrap.appendChild(sw); wrap.appendChild(name);
    calListEl.appendChild(wrap);

    const lg = document.createElement("span");
    lg.innerHTML = `<span class="sw" style="width:10px;height:10px;border-radius:3px;display:inline-block;background:${color}"></span>${cal.summary}`;
    legendEl.appendChild(lg);
  });
}

/* ======  Month grid & events ====== */
function renderMonth(){
  const y = current.getFullYear(), m = current.getMonth();
  const first = new Date(y,m,1);
  const start = new Date(first); start.setDate(first.getDate() - first.getDay());
  const today = new Date();
  const monthName = current.toLocaleDateString(undefined,{month:"long",year:"numeric"});
  monthLabel.textContent = monthName;

  cellsEl.innerHTML = "";
  for (let i=0;i<42;i++){
    const d = new Date(start); d.setDate(start.getDate()+i);
    const cell = document.createElement("div"); cell.className="day";
    if (d.getMonth() !== m) cell.classList.add("other");
    if (sameDate(d,today)) cell.classList.add("today");
    cell.dataset.date = isoDate(d);

    const num = document.createElement("div"); num.className="num"; num.textContent = d.getDate(); cell.appendChild(num);
    const evWrap = document.createElement("div"); evWrap.className="events"; cell.appendChild(evWrap);

    cell.onclick = () => openModalForDate(d);
    cellsEl.appendChild(cell);
  }
  paintEvents();
}

async function refreshEvents(){
  eventsByDay = {};
  if (!accessToken || activeCalIds.size===0) { paintEvents(); return; }

  const start = new Date(current.getFullYear(), current.getMonth(), 1);
  const end = new Date(current.getFullYear(), current.getMonth()+1, 1);
  const timeMin = start.toISOString();
  const timeMax = end.toISOString();

  const promises = calendars
    .filter(c=>activeCalIds.has(c.id))
    .map(async cal=>{
      const color = cal.backgroundColor || "#2563eb";
      const res = await gapi.client.calendar.events.list({
        calendarId: cal.id, timeMin, timeMax, singleEvents:true,
        orderBy:"startTime", maxResults:2500, showDeleted:false
      });
      (res.result.items||[]).forEach(evt=>{
        const dateKey = evt.start?.date || (evt.start?.dateTime||"").slice(0,10);
        if (!dateKey) return;
        (eventsByDay[dateKey] ||= []).push({ summary: evt.summary || "(No title)", color });
      });
    });

  try{ await Promise.all(promises); }catch(e){ console.error(e); setStatus("Load error"); }
  paintEvents();
}

function paintEvents(){
  [...cellsEl.children].forEach(cell=>{
    const dateKey = cell.dataset.date;
    const list = cell.querySelector(".events");
    list.innerHTML = "";
    const items = eventsByDay[dateKey] || [];
    items.slice(0,3).forEach(e=>{
      const pill = document.createElement("div");
      pill.className="pill"; pill.textContent = e.summary;
      pill.style.background = hexA(e.color || "#2563eb", .28);
      pill.style.border = "1px solid " + (e.color || "#2563eb");
      list.appendChild(pill);
    });
    if (items.length>3){
      const more = document.createElement("div");
      more.className="pill"; more.textContent = `+${items.length-3} more`;
      more.style.background="#1f2937"; more.style.border="1px dashed #334155";
      list.appendChild(more);
    }
  });
}

/* ======  Create event  ====== */
let modalDate = null;
function openModalForDate(d){
  if (!accessToken){ alert("Please sign in first."); return; }
  modalDate = new Date(d);
  document.getElementById("modalTitle").textContent =
    "Create event – " + d.toLocaleDateString(undefined,{weekday:"short",month:"short",day:"numeric"});
  evtSummary.value = "";
  evtAllDay.checked = false;
  timeRow.style.display = "flex";
  modalMsg.textContent = "";
  evtCalSel.innerHTML = "";
  calendars.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.id; opt.textContent = c.summary;
    opt.selected = activeCalIds.has(c.id);
    evtCalSel.appendChild(opt);
  });
  modalEl.classList.add("open");
}
function closeModal(){ modalEl.classList.remove("open"); }

async function saveEvent(){
  const calId = evtCalSel.value;
  const summary = evtSummary.value.trim() || "New event";
  const allDay = evtAllDay.checked;
  const dateStr = isoDate(modalDate);
  let start, end;
  if (allDay){
    start = { date: dateStr };
    const endDate = new Date(modalDate); endDate.setDate(endDate.getDate()+1);
    end = { date: isoDate(endDate) };
  } else {
    const [sh,sm] = (evtStart.value||"09:00").split(":").map(Number);
    const [eh,em] = (evtEnd.value||"10:00").split(":").map(Number);
    const s = new Date(modalDate); s.setHours(sh,sm,0,0);
    const e = new Date(modalDate); e.setHours(eh,em,0,0);
    start = { dateTime: s.toISOString(), timeZone: TZ };
    end   = { dateTime: e.toISOString(), timeZone: TZ };
  }

  modalMsg.textContent = "Saving…";
  try{
    await gapi.client.calendar.events.insert({ calendarId: calId, resource: { summary, start, end } });
    modalMsg.textContent = "Saved!";
    closeModal();
    await refreshEvents();
  }catch(e){
    console.error(e);
    modalMsg.textContent = "Could not save event: " + (e?.result?.error?.message || e.message || e);
  }
}

/* ======  Sign out  ====== */
function signOut(){
  if (accessToken) google.accounts.oauth2.revoke(accessToken, ()=>{});
  accessToken = undefined;
  btnSignIn.style.display=""; btnSignOut.style.display="none";
  userChip.style.display="none";
  setStatus("");
  eventsByDay = {}; paintEvents();
}

/* ======  Kick everything off ====== */
(function waitForLibs(){
  if (window.gapi && window.google && window.google.accounts && window.google.accounts.oauth2) {
    gapiLoaded(); gisLoaded();
  } else {
    setTimeout(waitForLibs, 80);
  }
})();
</script>
</body>
</html>
